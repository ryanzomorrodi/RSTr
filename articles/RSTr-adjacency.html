<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>02: Understanding and Preparing Your Adjacency Structure • RSTr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="02: Understanding and Preparing Your Adjacency Structure">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">RSTr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.9</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/RSTr.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/RSTr-event.html">01: Understanding and Preparing Your Event Data</a></li>
    <li><a class="dropdown-item" href="../articles/RSTr-adjacency.html">02: Understanding and Preparing Your Adjacency Structure</a></li>
    <li><a class="dropdown-item" href="../articles/RSTr-car.html">03: The CAR Models</a></li>
    <li><a class="dropdown-item" href="../articles/RSTr-agestandardize.html">04: Generating Estimates: Age-standardization</a></li>
    <li><a class="dropdown-item" href="../articles/RSTr-reliability.html">05: Generating Estimates: Reliability and Suppression</a></li>
    <li><a class="dropdown-item" href="../articles/RSTr-informativeness.html">06: Model Informativeness</a></li>
    <li><a class="dropdown-item" href="../articles/RSTr-samples.html">07: Sample Processing</a></li>
    <li><a class="dropdown-item" href="../articles/RSTr-initialvalues.html">08: Initial Values</a></li>
    <li><a class="dropdown-item" href="../articles/RSTr-priors.html">09: Priors</a></li>
    <li><a class="dropdown-item" href="../articles/RSTr-models.html">Appendix A: The CAR Hierarchical Models</a></li>
    <li><a class="dropdown-item" href="../articles/RSTr-troubleshoot.html">Appendix B: Troubleshooting</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>02: Understanding and Preparing Your Adjacency Structure</h1>
            
      

      <div class="d-none name"><code>RSTr-adjacency.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="sec-overview">Overview<a class="anchor" aria-label="anchor" href="#sec-overview"></a>
</h2>
<p>The adjacency structure is a set of instructions that show the
spatial relationship between each region and informs <code>RSTr</code>
which counties to pull information from when spatially smoothing. In
this vignette, we will cover the requirements for the
<code>adjacency</code> object along with walking through the setup of
the adjacency information.</p>
</div>
<div class="section level2">
<h2 id="requirements">Requirements<a class="anchor" aria-label="anchor" href="#requirements"></a>
</h2>
<p>Adjacency information is input as a <code>list</code>
<code>adj</code> where each element <code>adj[[i]]</code> is a vector of
indices denoting regions that are neighbors of region <code>i</code>.
Below, we will walk through the construction of the adjacency
information and address common issues that may arise.</p>
</div>
<div class="section level2">
<h2 id="example-massachusetts-map-data">Example: Massachusetts Map Data<a class="anchor" aria-label="anchor" href="#example-massachusetts-map-data"></a>
</h2>
<p>For this example, we will continue using Massachusetts data as we did
in section 2. Included is an example dataset that contains Massachusetts
shapefile information, generated using the <code>tigris</code>
package:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">mamap</span><span class="op">)</span></span></code></pre></div>
<p>This dataset contains several variables related to Census information
on Massachusetts, but for our purposes we are only interested in two
variables:</p>
<ul>
<li><p><code>GEOID</code> contains the FIPS code for each county. We can
use this to associate each county with the counties in our
event/population data; and</p></li>
<li><p><code>geometry</code> describes how to map each region. We can
use this to generate our adjacency information.</p></li>
</ul>
<p>To begin, let’s first arrange <code>mamap</code> by
<code>GEOID</code> to ensure the counties are in the same order as our
<code>maexample</code> data, then generate some adjacency information
using the <code>spdep</code> package:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ma_shp</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">mamap</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">mamap</span><span class="op">$</span><span class="va">GEOID</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="va">ma_adj</span> <span class="op">&lt;-</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/poly2nb.html" class="external-link">poly2nb</a></span><span class="op">(</span><span class="va">ma_shp</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in spdep::poly2nb(ma_shp): some observations have no neighbours;</span></span>
<span><span class="co">#&gt; if this seems unexpected, try increasing the snap argument.</span></span>
<span><span class="co">#&gt; Warning in spdep::poly2nb(ma_shp): neighbour object has 3 sub-graphs;</span></span>
<span><span class="co">#&gt; if this sub-graph count seems unexpected, try increasing the snap argument.</span></span></code></pre></div>
<p><code><a href="https://r-spatial.github.io/spdep/reference/poly2nb.html" class="external-link">spdep::poly2nb()</a></code> takes the information in
<code>ma_shp$geometry</code> and looks for any regions with touching
boundaries (i.e., queen contiguity). <code>ma_adj</code> is a list that
contains the indices of each region that is a neighbor with a given
region. Looking at <code>ma_adj</code> gives us some more
information:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ma_adj</span></span>
<span><span class="co">#&gt; Neighbour list object:</span></span>
<span><span class="co">#&gt; Number of regions: 14 </span></span>
<span><span class="co">#&gt; Number of nonzero links: 38 </span></span>
<span><span class="co">#&gt; Percentage nonzero weights: 19.38776 </span></span>
<span><span class="co">#&gt; Average number of links: 2.714286 </span></span>
<span><span class="co">#&gt; 2 regions with no links:</span></span>
<span><span class="co">#&gt; 1252, 1577</span></span>
<span><span class="co">#&gt; 3 disjoint connected subgraphs</span></span></code></pre></div>
<p><code>ma_adj</code> tells that there are 14 regions linked in 38
unique ways. However, it also notes that there are two regions with no
links. Regions with no links are problematic for <code>RSTr</code>
because it has no information with which to spatially smooth, causing
the model to crash. Because our data is in this incomplete format, we
will have to do some investigation and fixing to get it ready for
use.</p>
<p>Let us first look at the dataset to see which counties have no
neighbors. <code>ma_adj</code> tells us that regions 4 and 10 are our
regions with no links, but we can also use <code><a href="https://r-spatial.github.io/spdep/reference/card.html" class="external-link">spdep::card()</a></code> to
give us the indices of our no-link counties:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">no_neigh</span> <span class="op">&lt;-</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/card.html" class="external-link">card</a></span><span class="op">(</span><span class="va">ma_adj</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span></span></code></pre></div>
<p>We can now investigate <code>ma_shp</code> for the counties with no
neighbors:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ma_shp</span><span class="op">[</span><span class="va">no_neigh</span>, <span class="op">]</span></span>
<span><span class="co">#&gt; Simple feature collection with 2 features and 12 fields</span></span>
<span><span class="co">#&gt; Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -70.95137 ymin: 41.23796 xmax: -69.96018 ymax: 41.52178</span></span>
<span><span class="co">#&gt; Geodetic CRS:  NAD83</span></span>
<span><span class="co">#&gt;      STATEFP COUNTYFP COUNTYNS       AFFGEOID GEOID      NAME         NAMELSAD</span></span>
<span><span class="co">#&gt; 1252      25      007 00606930 0500000US25007 25007     Dukes     Dukes County</span></span>
<span><span class="co">#&gt; 1577      25      019 00606936 0500000US25019 25019 Nantucket Nantucket County</span></span>
<span><span class="co">#&gt;      STUSPS    STATE_NAME LSAD     ALAND     AWATER</span></span>
<span><span class="co">#&gt; 1252     MA Massachusetts   06 267292993 1004291414</span></span>
<span><span class="co">#&gt; 1577     MA Massachusetts   06 119637319  666826424</span></span>
<span><span class="co">#&gt;                            geometry</span></span>
<span><span class="co">#&gt; 1252 MULTIPOLYGON (((-70.8071 41...</span></span>
<span><span class="co">#&gt; 1577 MULTIPOLYGON (((-70.23405 4...</span></span></code></pre></div>
<p>According to this, our two no-link counties are Dukes and Nantucket
(FIPS 25007 and 25019, respectively). Let’s check out a ggplot of our
data to further investigate:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">mamap</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">NAME</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf_label</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">NAME</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="RSTr-adjacency_files/figure-html/unnamed-chunk-7-1.png" class="r-plt" width="700"></p>
<p>Here, we’ve generated a map colored by region and labeled with the
name of each county. We can see Dukes and Nantucket in the southeast
corner, and if you zoom in, you can see that these two counties aren’t
touching any other counties. Upon closer inspection, Barnstable County
seems like a good contender for a neighbor to both Dukes and Nantucket
County; Dukes and Nantucket County are also close enough to be neighbors
to each other. To rectify this, we can make some changes to our
adjacency information. Let’s first get a feel for which counties are
associated with which indices:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">county_key</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">ma_shp</span><span class="op">$</span><span class="va">NAME</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">county_key</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">ma_shp</span><span class="op">$</span><span class="va">NAME</span></span>
<span><span class="va">county_key</span></span>
<span><span class="co">#&gt; Barnstable  Berkshire    Bristol      Dukes      Essex   Franklin    Hampden </span></span>
<span><span class="co">#&gt;          1          2          3          4          5          6          7 </span></span>
<span><span class="co">#&gt;  Hampshire  Middlesex  Nantucket    Norfolk   Plymouth    Suffolk  Worcester </span></span>
<span><span class="co">#&gt;          8          9         10         11         12         13         14</span></span></code></pre></div>
<p>We can see that Barnstable has an index of 1, Dukes has an index of
4, and Nantucket has an index of 10. We can use the
<code><a href="../reference/add_neighbors.html">add_neighbors()</a></code> function to set these counties as mutual
neighbors:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ma_adj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/add_neighbors.html">add_neighbors</a></span><span class="op">(</span><span class="va">ma_adj</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now if we look at <code>ma_adj</code>, the message about no-link
regions is gone.</p>
<p>Note that if you run a model in <code>RSTr</code> and load in the
adjacency information saved in your model object, the indices will have
changed. This is because adjacency information is only used within Rcpp,
which uses a 0-indexing system as opposed to the 1-indexing system used
by R. When inputting data into <code>*car()</code>, only use a 1-indexed
adjacency structure.</p>
<p>Finally, even though we connected the two island counties to the
mainland counties of MA, as long as each region has at least one
neighbor, it is usable within <code>RSTr</code>. This means that,
theoretically, we could have made just Dukes and Nantucket neighbors of
each other, creating two separate islands with no related neighbors. In
this case, every region on both islands still has at least one
neighbor.</p>
</div>
<div class="section level2">
<h2 id="closing-thoughts">Closing Thoughts<a class="anchor" aria-label="anchor" href="#closing-thoughts"></a>
</h2>
<p>In this vignette, we used <code><a href="https://r-spatial.github.io/spdep/reference/poly2nb.html" class="external-link">spdep::poly2nb()</a></code> to generate
our adjacency structure. We then fixed issues with counties without
neighbors and applied a naming scheme to the adjacency information
consistent with the <code>data</code> object created in section 2. From
here, the <code>RSTr</code> model is ready to be run with our
<code>data</code> and <code>adjacency</code> information!</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by David DeLara, Centers for Disease Control and Prevention.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
